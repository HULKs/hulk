# Unified cross-compilation toolchain for T1 and K1 robots
FROM nvcr.io/nvidia/jetpack-linux-aarch64-crosscompile-x86:6.1

LABEL maintainer="HULKs"
LABEL description="Cross-compilation toolchain for T1 and K1 robots"
LABEL version="6.1"
LABEL target="k1"

USER root

WORKDIR /l4t

# Combine and extract the Target File System (Sysroot)
RUN cat targetfs.tbz2.* > targetfs.tbz2 && \
    tar -I lbzip2 -xf targetfs.tbz2 && \
    rm targetfs.tbz2*

# Extract the Cross-Compilation Toolchain
RUN mkdir -p toolchain && \
    tar -C toolchain -xf toolchain.tar.bz2 && \
    rm toolchain.tar.bz2

# Point to the extracted toolchain
ENV CROSS_ROOT=/l4t/toolchain/aarch64--glibc--stable-2022.08-1
ENV SYSROOT=/l4t/targetfs

# Add the toolchain binary path to PATH
ENV PATH="${CROSS_ROOT}/bin:${PATH}"

ENV PKG_CONFIG=/usr/bin/pkg-config
ENV PKG_CONFIG_SYSROOT_DIR_aarch64_unknown_linux_gnu="${SYSROOT}"
ENV PKG_CONFIG_PATH_aarch64_unknown_linux_gnu="${SYSROOT}/usr/lib/aarch64-linux-gnu/pkgconfig:${SYSROOT}/usr/share/pkgconfig:${SYSROOT}/usr/lib/pkgconfig"
ENV PKG_CONFIG_ALLOW_CROSS=1

# C compiler variables for cc-rs (used by build.rs scripts)
ENV CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
ENV CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
ENV AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar

# Install standard tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl=7.81.* \
    build-essential=12.* \
    pkg-config=0.29.* \
    libclang-dev=1:14.* \
    && rm -rf /var/lib/apt/lists/*

# Install Rust and add the AArch64 target
ENV RUSTUP_TOOLCHAIN=1.91.1
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup target add --toolchain ${RUSTUP_TOOLCHAIN} aarch64-unknown-linux-gnu

COPY cargo-config.toml /root/.cargo/config.toml

ENV BINDGEN_EXTRA_CLANG_ARGS_aarch64_unknown_linux_gnu="\
    --sysroot=/l4t/targetfs \
    -I/l4t/targetfs/usr/include \
    -I/l4t/targetfs/usr/include/aarch64-linux-gnu"

ENV MOLD_VERSION=2.40.4
RUN curl -L https://github.com/rui314/mold/releases/download/v${MOLD_VERSION}/mold-${MOLD_VERSION}-x86_64-linux.tar.gz \
    -o mold.tar.gz && \
    tar -xf mold.tar.gz && \
    mv mold-${MOLD_VERSION}-x86_64-linux/bin/mold /usr/bin/mold && \
    mv mold-${MOLD_VERSION}-x86_64-linux/lib/mold /usr/lib/mold && \
    rm -rf mold.tar.gz mold-${MOLD_VERSION}-x86_64-linux && \
    chmod +x /usr/bin/mold && \
    mkdir -p /usr/libexec/mold && \
    ln -sf /usr/bin/mold /usr/libexec/mold/ld

# Install HULKs specific dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libssl-dev=3.0.* && \
    rm -rf /var/lib/apt/lists/*

# Reset working directory
WORKDIR /workspace

# # Install ZED SDK
# RUN mkdir -p /zed2  && \
#     wget -nv "https://download.stereolabs.com/zedsdk/5.0/l4t36.4/jetsons" -O /zed2/ZED_SDK_Tegra_L4T36.3_v5.0.1.zstd.run && \
#     chmod +x /zed2/ZED_SDK_Tegra_L4T36.3_v5.0.1.zstd.run && \
#     /zed2/ZED_SDK_Tegra_L4T36.3_v5.0.1.zstd.run --noexec --target /l4t/targetfs/usr/ && \
#     rm -rf /zed2 && \
#     rm -rf /var/lib/apt/lists/*

# # Clone and build booster SDK for arm64
# # Upstream currently has no 'install' target; build and copy artifacts manually
# RUN git clone https://github.com/BoosterRobotics/booster_robotics_sdk.git /tmp/booster-sdk && \
#     cd /tmp/booster-sdk && \
#     git checkout 75e38b19f98becfcbf298b1c1a04171c2e7d8b8f && \
#     mkdir -p ${TARGET_FS}/usr/lib ${TARGET_FS}/usr/include && \
#     cp -a /tmp/booster-sdk/third_party/include/. ${TARGET_FS}/usr/include/ && \
#     cp -a /tmp/booster-sdk/third_party/lib/aarch64/libfastcdr.so* ${TARGET_FS}/usr/lib/ && \
#     cp -a /tmp/booster-sdk/third_party/lib/aarch64/libfastrtps.so* ${TARGET_FS}/usr/lib/ && \
#     cp -a /tmp/booster-sdk/third_party/lib/aarch64/libfoonathan_memory-0.7.3.a ${TARGET_FS}/usr/lib/ && \
#     cp -a /tmp/booster-sdk/lib/aarch64/libbooster_robotics_sdk.a ${TARGET_FS}/usr/lib/ && \
#     cp -a /tmp/booster-sdk/include/. ${TARGET_FS}/usr/include/ && \
#     rm -rf /tmp/booster-sdk
#
# COPY toolchains.cmake /toolchains/toolchains.cmake
#
# Build and install librealsense2 for arm64
# RUN git clone --depth 1 --branch v2.55.1 https://github.com/IntelRealSense/librealsense.git /third_party/librealsense && \
#     cd /third_party/librealsense && \
#    mkdir -p build && cd build && \
#    cmake -DCMAKE_TOOLCHAIN_FILE=/toolchains/toolchains.cmake \
#        -DBUILD_SHARED_LIBS=ON \
#        -DBUILD_EXAMPLES=OFF \
#        -DBUILD_GRAPHICAL_EXAMPLES=OFF \
#        -DBUILD_WITH_CUDA=ON \
#        -DBUILD_WITH_OPENMP=OFF \
#        -DBUILD_PYTHON_BINDINGS=OFF \
#        -DBUILD_UNIT_TESTS=OFF \
#        -DFORCE_LIBUVC=ON \
#       -DCMAKE_BUILD_TYPE=Release \
#       -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-12.6 \
#        -DCUDA_CUDART_LIBRARY=/usr/local/cuda-12.6/targets/aarch64-linux/lib/libcudart.so \
#        -DCUDA_cudart_static_LIBRARY=/usr/local/cuda-12.6/targets/aarch64-linux/lib/libcudart_static.a \
#        -DCUDA_cudadevrt_LIBRARY=/usr/local/cuda-12.6/targets/aarch64-linux/lib/libcudadevrt.a \
#       -DCUDA_INCLUDE_DIRS=/usr/local/cuda-12.6/targets/aarch64-linux/include \
#       -DCUDA_HOST_COMPILER=/l4t/toolchain/aarch64--glibc--stable-2022.08-1/bin/aarch64-buildroot-linux-gnu-g++ \
#        -DCMAKE_CUDA_COMPILER=/usr/local/cuda-12.6/bin/nvcc \
#        -DCMAKE_CUDA_ARCHITECTURES=87 \
#        -DCMAKE_INSTALL_PREFIX=${TARGET_FS}/usr \
#        .. && \
#    make -j$(nproc) install
