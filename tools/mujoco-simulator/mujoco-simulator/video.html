<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Broadway.js (CDN) WebSocket H.264 demo</title>
        <style>
            body {
                font-family: sans-serif;
            }
            #container {
                width: 640px;
                height: 480px;
                background: #000;
            }
        </style>
    </head>
    <body>
        <h3>Broadway.js (from CDN) WebSocket H.264 player</h3>
        <div id="container"></div>

        <!-- Broadway from CDN (cdnjs) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Broadway/0.1.0/Decoder.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Broadway/0.1.0/WebGLCanvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Broadway/0.1.0/Player.min.js"></script>

        <script>
            // Minimal client: open websocket, feed received Annex-B H264 packets directly to Broadway Player

            const WS_URL = "ws://localhost:8000/simulation/camera"; // point to your Python server
            const ws = new WebSocket(WS_URL);
            ws.binaryType = "arraybuffer";

            // Create the Broadway Player.
            // useWorker:false keeps everything in main thread and avoids needing extra worker files on CDN.
            const player = new Player({
                useWorker: false,
                webgl: "auto",
                size: { width: 640, height: 480 },
            });

            // append Broadway's canvas into container
            document.getElementById("container").appendChild(player.canvas);

            ws.onopen = () => console.log("ws open to", WS_URL);
            ws.onclose = () => console.log("ws closed");
            ws.onerror = (e) => console.error("ws error", e);

            // Server sends Annex-B H264 packets as single binary messages (start codes included)
            ws.onmessage = (ev) => {
                try {
                    const ab = ev.data;
                    if (!ab || ab.byteLength === 0) return;
                    const data = new Uint8Array(ab);
                    // Broadway expects Annex-B NAL stream; pass bytes directly
                    player.decode(data);
                } catch (err) {
                    console.error("decode error", err);
                }
            };
        </script>
    </body>
</html>
