name: CI Image
on:
  workflow_dispatch
jobs:
  build:
    name: Build
    runs-on:
      - self-hosted
      - v3
      - knoellchen
    steps:
      - name: Retrieve latest SDK version
        run: |
          echo SDK_VERSION=$(curl -s -L -I -o /dev/null -w '%{url_effective}' https://github.com/HULKs/meta-hulks/releases/latest | awk -F/ '{print $NF}') >> $GITHUB_OUTPUT
        id: retrieve_latest_version
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          build-args: SDK_VERSION=${{ steps.retrieve_latest_version.outputs.SDK_VERSION }}
          context: "{{ defaultContext }}:tools/ci/github-runners/v3
          push: true
          tags: ghcr.io/hulks/hulk:latest
